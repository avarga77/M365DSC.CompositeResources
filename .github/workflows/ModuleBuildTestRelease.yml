name: Module Build, Test and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - CHANGELOG.md
    tags:
      - v*
    #tags-ignore:
    #- '*-*'
  pull_request:

env:
  buildFolderName: output
  buildArtifactName: output
  testResultFolderName: testResults
  defaultBranch: main
  Agent.Source.Git.ShallowFetchDepth: 0

jobs:
  Build_Stage_Package_Module:
    name: Package Module
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Calculate ModuleVersion (GitVersion)
        id: GitVersion
        run: |
          $m365dscModule = Find-Module Microsoft365DSC
          $m365dscCRModule = Find-Module M365DSC.CompositeResources -ErrorAction SilentlyContinue
          if ($m365dscModule.Version -gt $m365dscCRModule.Version)
          {
            Write-Output "Version of Microsoft365DSC is newer than M365DSC.CompositeResources:"
            Write-Output "Microsoft365DSC: v$($m365dscModule.Version) / M365DSC.CompositeResources: v$($m365dscCRModule.Version)"
            Write-Output "ModuleVersion=$($m365dscModule.Version.ToString())" >> $env:GITHUB_OUTPUT
          }
          else
          {
            Write-Output "No new version of Microsoft365DSC found. Skipping build."
            exit 1
          }
        shell: powershell
      - name: Build & Package Module
        shell: powershell
        run: |
          ./build.ps1 -ResolveDependency -Tasks Build # Pack' -> Changed from Pack to Build. Pack does not work with nested required modules.

          Write-Output "Registring Output repository: $OutputDirectory"
          $RepositoryParams = @{
            Name            = 'output'
            SourceLocation  = $OutputDirectory
            PublishLocation = $OutputDirectory
            ErrorAction     = 'Stop'
          }
          $null = Register-PSRepository @RepositoryParams

          Write-Output "Publishing module to output repository: $BuiltModuleBase"
          $PublishModuleParams = @{
            Path            = $BuiltModuleBase
            Repository      = 'output'
            ErrorAction     = 'Stop'
            Force           = $true
          }

          Publish-Module @PublishModuleParams

          Write-Output "Removing Output repository"
          $null = Unregister-PSRepository -Name output -ErrorAction SilentlyContinue
        env:
          ModuleVersion: ${{ steps.GitVersion.outputs.ModuleVersion }}
      - name: Publish Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.buildArtifactName }}
          path: ${{ env.buildFolderName }}/
    outputs:
      ModuleVersion: ${{ steps.GitVersion.outputs.ModuleVersion }}

  Test_Stage_test_windows_ps:
    name: Windows (Windows PowerShell)
    runs-on: windows-latest
    needs:
      - Build_Stage_Package_Module
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.buildArtifactName }}
          path: ${{ env.buildFolderName }}/
      - name: Run Tests
        shell: powershell
        run: |
          ./build.ps1 -Tasks Test
        env:
          ModuleVersion: ${{ needs.Build_Stage_Package_Module.outputs.ModuleVersion }}
      - name: Publish Test Artifact
        uses: actions/upload-artifact@v3
        with:
          path: ${{ env.buildFolderName }}/${{ env.testResultFolderName }}/
          name: CodeCoverageWinPS51

  Deploy_Stage_Deploy_Module:
    name: Deploy Module
    runs-on: ubuntu-latest
    needs:
      - Build_Stage_Package_Module
      - Test_Stage_test_windows_ps
    if: (success() && ((github.ref == 'refs/heads/main') || startsWith(github.ref, 'refs/tags/')) && (contains(github.repository_owner, 'ykuijs')))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.buildArtifactName }}
          path: ${{ env.buildFolderName }}/
      - name: Publish Release
        shell: pwsh
        run: |
          Get-ChildItem
          ./build.ps1 -Tasks Publish
        env:
          GitHubToken: ${{ secrets.GITHUB_TOKEN }}
          GalleryApiToken: ${{ secrets.GalleryApiToken }}
          ReleaseBranch: ${{ env.defaultBranch }}
          MainGitBranch: ${{ env.defaultBranch }}
          ModuleVersion: ${{ needs.Build_Stage_Package_Module.outputs.ModuleVersion }}
      - name: Send Changelog PR
        shell: pwsh
        run: './build.ps1 -Tasks Create_ChangeLog_GitHub_PR'
        env:
          GitHubToken: ${{ secrets.GITHUB_TOKEN }}
          ReleaseBranch: ${{ env.defaultBranch }}
          MainGitBranch: ${{ env.defaultBranch }}
